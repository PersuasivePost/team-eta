{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Ashvatth/OneDrive/Desktop/AshWorks/clones/team-eta/app/auth/google/callback/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport fetch from \"node-fetch\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport pkg from \"pg\";\r\n\r\nconst { Pool } = pkg;\r\nconst pool = new Pool({ connectionString: process.env.DATABASE_URL });\r\n\r\nexport async function GET(req: Request) {\r\n  const url = new URL(req.url);\r\n  const origin = `${\r\n    req.headers.get(\"x-forwarded-proto\") || \"http\"\r\n  }://${req.headers.get(\"host\")}`;\r\n\r\n  try {\r\n    const code = url.searchParams.get(\"code\");\r\n    const state = url.searchParams.get(\"state\");\r\n    const parsedState = state ? JSON.parse(decodeURIComponent(state)) : {};\r\n    const next = parsedState.next || \"/\";\r\n\r\n    if (!code) return NextResponse.redirect(new URL(\"/auth\", origin));\r\n\r\n    const tokenRes = await fetch(\"https://oauth2.googleapis.com/token\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\r\n      body: new URLSearchParams({\r\n        code,\r\n        client_id: process.env.GOOGLE_CLIENT_ID || \"\",\r\n        client_secret: process.env.GOOGLE_CLIENT_SECRET || \"\",\r\n        redirect_uri:\r\n          process.env.OAUTH_REDIRECT_URL ||\r\n          `${\r\n            req.headers.get(\"x-forwarded-proto\") || \"http\"\r\n          }://${req.headers.get(\"host\")}/auth/google/callback`,\r\n        grant_type: \"authorization_code\",\r\n      }),\r\n    });\r\n\r\n    const tokenJson: any = await tokenRes.json();\r\n    const access_token = tokenJson.access_token;\r\n    if (!access_token) return NextResponse.redirect(new URL(\"/auth\", origin));\r\n\r\n    const profileRes = await fetch(\r\n      \"https://www.googleapis.com/oauth2/v2/userinfo\",\r\n      {\r\n        headers: { Authorization: `Bearer ${access_token}` },\r\n      }\r\n    );\r\n    const profile: any = await profileRes.json();\r\n\r\n    // upsert user\r\n    const { name, email } = profile;\r\n    const mobile = \"\";\r\n    const sql = `INSERT INTO users (name,email,mobile) VALUES ($1,$2,$3) ON CONFLICT (email) DO UPDATE SET name = EXCLUDED.name, updated_at = now() RETURNING *`;\r\n    const values = [name || \"\", email || \"\", mobile];\r\n    const resDb = await pool.query(sql, values);\r\n    const user = resDb.rows[0];\r\n\r\n    // create jwt\r\n    const token = jwt.sign(\r\n      { userId: user.id, email: user.email },\r\n      process.env.JWT_SECRET || \"dev-secret\",\r\n      { expiresIn: \"7d\" }\r\n    );\r\n\r\n    const response = NextResponse.redirect(new URL(next, origin));\r\n    response.cookies.set({\r\n      name: \"session\",\r\n      value: token,\r\n      httpOnly: true,\r\n      path: \"/\",\r\n      maxAge: 60 * 60 * 24 * 7,\r\n    });\r\n    return response;\r\n  } catch (err) {\r\n    console.error(\"oauth callback error\", err);\r\n    return NextResponse.redirect(new URL(\"/auth\", origin));\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;;;;;AAEA,MAAM,EAAE,IAAI,EAAE,GAAG,+GAAG;AACpB,MAAM,OAAO,IAAI,KAAK;IAAE,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAAC;AAE5D,eAAe,IAAI,GAAY;IACpC,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;IAC3B,MAAM,SAAS,GACb,IAAI,OAAO,CAAC,GAAG,CAAC,wBAAwB,OACzC,GAAG,EAAE,IAAI,OAAO,CAAC,GAAG,CAAC,SAAS;IAE/B,IAAI;QACF,MAAM,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC;QAClC,MAAM,QAAQ,IAAI,YAAY,CAAC,GAAG,CAAC;QACnC,MAAM,cAAc,QAAQ,KAAK,KAAK,CAAC,mBAAmB,UAAU,CAAC;QACrE,MAAM,OAAO,YAAY,IAAI,IAAI;QAEjC,IAAI,CAAC,MAAM,OAAO,4MAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,SAAS;QAEzD,MAAM,WAAW,MAAM,IAAA,sOAAK,EAAC,uCAAuC;YAClE,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAoC;YAC/D,MAAM,IAAI,gBAAgB;gBACxB;gBACA,WAAW,QAAQ,GAAG,CAAC,gBAAgB,IAAI;gBAC3C,eAAe,QAAQ,GAAG,CAAC,oBAAoB,IAAI;gBACnD,cACE,QAAQ,GAAG,CAAC,kBAAkB,IAC9B,GACE,IAAI,OAAO,CAAC,GAAG,CAAC,wBAAwB,OACzC,GAAG,EAAE,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,qBAAqB,CAAC;gBACtD,YAAY;YACd;QACF;QAEA,MAAM,YAAiB,MAAM,SAAS,IAAI;QAC1C,MAAM,eAAe,UAAU,YAAY;QAC3C,IAAI,CAAC,cAAc,OAAO,4MAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,SAAS;QAEjE,MAAM,aAAa,MAAM,IAAA,sOAAK,EAC5B,iDACA;YACE,SAAS;gBAAE,eAAe,CAAC,OAAO,EAAE,cAAc;YAAC;QACrD;QAEF,MAAM,UAAe,MAAM,WAAW,IAAI;QAE1C,cAAc;QACd,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG;QACxB,MAAM,SAAS;QACf,MAAM,MAAM,CAAC,8IAA8I,CAAC;QAC5J,MAAM,SAAS;YAAC,QAAQ;YAAI,SAAS;YAAI;SAAO;QAChD,MAAM,QAAQ,MAAM,KAAK,KAAK,CAAC,KAAK;QACpC,MAAM,OAAO,MAAM,IAAI,CAAC,EAAE;QAE1B,aAAa;QACb,MAAM,QAAQ,8MAAG,CAAC,IAAI,CACpB;YAAE,QAAQ,KAAK,EAAE;YAAE,OAAO,KAAK,KAAK;QAAC,GACrC,QAAQ,GAAG,CAAC,UAAU,IAAI,cAC1B;YAAE,WAAW;QAAK;QAGpB,MAAM,WAAW,4MAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,MAAM;QACrD,SAAS,OAAO,CAAC,GAAG,CAAC;YACnB,MAAM;YACN,OAAO;YACP,UAAU;YACV,MAAM;YACN,QAAQ,KAAK,KAAK,KAAK;QACzB;QACA,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,4MAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,SAAS;IAChD;AACF"}}]
}